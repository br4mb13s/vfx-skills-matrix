<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flying Bark Skills Assessment System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2E86AB, #A23B72);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .header {
            background: linear-gradient(135deg, #2E86AB, #A23B72);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .btn.active {
            background: rgba(255,255,255,0.4);
            border-color: rgba(255,255,255,0.6);
        }

        .btn.supervisor-only {
            display: inline-block;
            opacity: 0.8;
        }

        .btn.supervisor-only.visible {
            display: inline-block;
            opacity: 1;
        }

        .view {
            display: none;
            padding: 30px;
        }

        .view.active {
            display: block;
        }

        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .employee-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .employee-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-color: #2E86AB;
        }

        .employee-name {
            font-size: 1.4em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .employee-role {
            color: #6c757d;
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .completion-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            display: inline-block;
        }

        .completed {
            background: #d4edda;
            color: #155724;
        }

        .pending {
            background: #fff3cd;
            color: #856404;
        }

        .not-started {
            background: #f8d7da;
            color: #721c24;
        }

        .assessment-form {
            max-width: 800px;
            margin: 0 auto;
        }

        .skills-section {
            margin-bottom: 40px;
        }

        .section-title {
            background: #2E86AB;
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            font-size: 1.2em;
            font-weight: 600;
        }

        .skills-grid {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 8px 8px;
        }

        .skill-row {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
        }

        .skill-row:last-child {
            border-bottom: none;
        }

        .skill-name {
            flex: 1;
            font-weight: 500;
            color: #2c3e50;
        }

        .rating-buttons {
            display: flex;
            gap: 8px;
        }

        .rating-btn {
            padding: 8px 16px;
            border: 3px solid transparent;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 700;
            transition: all 0.3s ease;
            background: #e9ecef;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 90px;
            text-align: center;
            opacity: 0.4;
        }

        .rating-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0.7;
        }

        .rating-btn.selected {
            border-color: currentColor;
            transform: scale(1.12);
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            position: relative;
            opacity: 1;
        }

        .rating-btn.selected::after {
            content: '✓';
            position: absolute;
            top: -8px;
            right: -8px;
            background: white;
            color: inherit;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid currentColor;
        }

        .skill-row:hover .rating-btn:not(.selected) {
            opacity: 0.8;
        }

        .rating-btn.expert { 
            background: linear-gradient(135deg, #2E86AB, #4a9bc7); 
            color: white; 
        }
        
        .rating-btn.expert.selected { 
            background: linear-gradient(135deg, #236b8a, #3a7ba3);
            box-shadow: 0 6px 20px rgba(46, 134, 171, 0.4);
        }
        
        .rating-btn.advanced { 
            background: linear-gradient(135deg, #A23B72, #c4598a); 
            color: white; 
        }
        
        .rating-btn.advanced.selected { 
            background: linear-gradient(135deg, #812e5a, #9d4e7a);
            box-shadow: 0 6px 20px rgba(162, 59, 114, 0.4);
        }
        
        .rating-btn.intermediate { 
            background: linear-gradient(135deg, #CA653A, #df7d56); 
            color: white; 
        }
        
        .rating-btn.intermediate.selected { 
            background: linear-gradient(135deg, #a5512e, #c16442);
            box-shadow: 0 6px 20px rgba(202, 101, 58, 0.4);
        }
        
        .rating-btn.beginner { 
            background: linear-gradient(135deg, #F18F01, #f4a434); 
            color: white; 
        }
        
        .rating-btn.beginner.selected { 
            background: linear-gradient(135deg, #c17201, #d67e0d);
            box-shadow: 0 6px 20px rgba(241, 143, 1, 0.4);
        }

        .progress-bar {
            background: #e9ecef;
            height: 8px;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #2E86AB, #A23B72);
            height: 100%;
            transition: width 0.3s ease;
        }

        .save-btn {
            background: linear-gradient(135deg, #2E86AB, #A23B72);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(46, 134, 171, 0.3);
        }

        .save-btn:hover {
            background: linear-gradient(135deg, #236b8a, #812e5a);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 134, 171, 0.4);
        }

        .overview-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .overview-table th,
        .overview-table td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
        }

        .overview-table th {
            background: #2E86AB;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .overview-table th:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            z-index: 11;
            background: #A23B72;
        }

        .overview-table td:first-child {
            background: #f8f9fa;
            font-weight: 600;
            text-align: left;
            position: sticky;
            left: 0;
            z-index: 9;
            min-width: 200px;
        }

        .skill-rating {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .expert { background: #2E86AB; color: white; }
        .advanced { background: #A23B72; color: white; }
        .intermediate { background: #CA653A; color: white; }
        .beginner { background: #F18F01; color: white; }
        .not-assessed { background: #6c757d; color: white; }

        .filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
        }

        select, input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }

        .export-btn {
            background: linear-gradient(135deg, #CA653A, #F18F01);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(202, 101, 58, 0.3);
        }

        .export-btn:hover {
            background: linear-gradient(135deg, #a5512e, #c17201);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(202, 101, 58, 0.4);
        }

        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .password-modal {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .password-modal h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .password-modal input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
        }

        .password-modal input:focus {
            outline: none;
            border-color: #2E86AB;
            box-shadow: 0 0 0 3px rgba(46, 134, 171, 0.1);
        }

        .password-modal .btn {
            background: linear-gradient(135deg, #2E86AB, #A23B72);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 0 10px;
        }

        .password-modal .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(46, 134, 171, 0.3);
        }

        .password-hint {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.95em;
            color: #495057;
        }

        .auto-save-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(40, 167, 69, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .auto-save-indicator.show {
            opacity: 1;
        }

        .session-info {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(46, 134, 171, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .analytics-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #2E86AB;
        }

        .analytics-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .analytics-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #2E86AB;
            margin-bottom: 5px;
        }

        .analytics-label {
            color: #6c757d;
            font-size: 0.9em;
        }

        .add-employee-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px dashed #2E86AB;
        }

        .add-employee-form {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select {
            padding: 10px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2E86AB;
            box-shadow: 0 0 0 3px rgba(46, 134, 171, 0.1);
        }

        .add-btn {
            background: linear-gradient(135deg, #2E86AB, #A23B72);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            height: fit-content;
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 134, 171, 0.3);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .nav-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .employee-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .rating-buttons {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1>Flying Bark Skills Assessment</h1>
                <p>Individual assessments with supervisor overview</p>
                <div class="nav-buttons">
                    <button class="btn active" onclick="showView('home')">Home</button>
                    <button class="btn" onclick="showView('assessment')">Self Assessment</button>
                    <button class="btn supervisor-only" onclick="requestSupervisorAccess()">Supervisor Overview</button>
                </div>
            </div>

            <!-- Home View -->
            <div id="home" class="view active">
                <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">Select Your Assessment</h2>
                <div class="employee-grid" id="employeeGrid">
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <h3>Loading team members...</h3>
                        <p>Please wait while we load the employee list.</p>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 40px; padding: 30px; background: #f8f9fa; border-radius: 12px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">Instructions</h3>
                    <p style="color: #6c757d; line-height: 1.6; max-width: 600px; margin: 0 auto;">
                        Click on your name above to complete your skills assessment. Your responses are private and only visible to supervisors in the overview. 
                        Be honest about your current skill levels - this helps identify training opportunities and project assignments.
                    </p>
                </div>
            </div>

            <!-- Assessment View -->
            <div id="assessment" class="view">
                <div class="assessment-form">
                    <h2 style="text-align: center; margin-bottom: 20px; color: #2c3e50;">Skills Assessment</h2>
                    <div id="currentEmployee" style="text-align: center; margin-bottom: 30px; font-size: 1.2em; color: #6c757d;"></div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <div style="text-align: center; margin-bottom: 30px; color: #6c757d;">
                        <span id="progressText">0% Complete</span>
                    </div>

                    <div id="skillsSections">
                        <!-- Skills sections will be populated by JavaScript -->
                    </div>

                    <div style="text-align: center;">
                        <button class="save-btn" onclick="saveAssessment()">Save Assessment</button>
                        <button class="btn" onclick="showView('home')" style="margin-left: 15px; background: #6c757d;">Back to Home</button>
                    </div>
                </div>
            </div>

            <!-- Overview View -->
            <div id="overview" class="view">
                <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">Supervisor Overview</h2>
                
                <!-- Add New Employee Section -->
                <div class="add-employee-section">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">Team Management</h3>
                    
                    <!-- Add Individual Employee -->
                    <div style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid #dee2e6;">
                        <h4 style="margin-bottom: 15px; color: #495057;">Add Individual Team Member</h4>
                        <div class="add-employee-form">
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" id="newEmployeeName" placeholder="Enter full name">
                            </div>
                            <div class="form-group">
                                <label>Role</label>
                                <select id="newEmployeeRole">
                                    <option value="">Select Role</option>
                                    <option value="Junior Artist">Junior Artist</option>
                                    <option value="Artist">Artist</option>
                                    <option value="Senior Artist">Senior Artist</option>
                                    <option value="Lead Artist">Lead Artist</option>
                                    <option value="Supervisor">Supervisor</option>
                                    <option value="CG Supervisor">CG Supervisor</option>
                                    <option value="VFX Supervisor">VFX Supervisor</option>
                                    <option value="Asset Supervisor">Asset Supervisor</option>
                                    <option value="Anim Supervisor">Anim Supervisor</option>
                                    <option value="Comp Supervisor">Comp Supervisor</option>
                                    <option value="Frontend CG Supervisor">Frontend CG Supervisor</option>
                                </select>
                            </div>
                            <button class="add-btn" onclick="addNewEmployee()">Add Team Member</button>
                        </div>
                    </div>
                    
                    <!-- Bulk Import/Export -->
                    <div>
                        <h4 style="margin-bottom: 15px; color: #495057;">Bulk Employee Management</h4>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                            <button class="export-btn" onclick="exportEmployees()">Export All Employees</button>
                            <button class="export-btn" style="background: linear-gradient(135deg, #28a745, #20c997);" onclick="exportEmployeeTemplate()">Download Template</button>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="file" id="employeeImportFile" accept=".csv,.json" style="display: none;" onchange="importEmployees(event)">
                                <button class="export-btn" style="background: linear-gradient(135deg, #6f42c1, #8b5cf6);" onclick="document.getElementById('employeeImportFile').click()">Import Employees</button>
                            </div>
                        </div>
                        <p style="margin-top: 10px; font-size: 0.85em; color: #6c757d;">
                            Supports CSV or JSON format. CSV columns: Name, Role, Password (optional)
                        </p>
                    </div>
                </div>
                
                <!-- Skills Management Section -->
                <div class="add-employee-section" style="margin-top: 20px;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">Skills Management</h3>
                    
                    <!-- Add New Skill -->
                    <div style="margin-bottom: 25px;">
                        <h4 style="margin-bottom: 15px; color: #495057;">Add New Skill</h4>
                        <div class="add-employee-form">
                            <div class="form-group">
                                <label>Category</label>
                                <select id="skillCategory">
                                    <option value="">Select Category</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>New Skill Name</label>
                                <input type="text" id="newSkillName" placeholder="Enter skill name">
                            </div>
                            <button class="add-btn" onclick="addNewSkill()">Add Skill</button>
                        </div>
                    </div>
                    
                    <!-- Add New Category -->
                    <div style="padding-top: 25px; border-top: 1px solid #dee2e6;">
                        <h4 style="margin-bottom: 15px; color: #495057;">Add New Category</h4>
                        <div class="add-employee-form">
                            <div class="form-group">
                                <label>Category Name</label>
                                <input type="text" id="newCategoryName" placeholder="Enter category name (e.g., 'AI TOOLS')">
                            </div>
                            <button class="add-btn" style="background: linear-gradient(135deg, #dc3545, #fd7e14);" onclick="addNewCategory()">Add Category</button>
                        </div>
                    </div>
                    
                    <!-- Export/Import Skills -->
                    <div style="margin-top: 25px; padding-top: 25px; border-top: 1px solid #dee2e6;">
                        <h4 style="margin-bottom: 15px; color: #495057;">Skills Import/Export</h4>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button class="export-btn" onclick="exportSkills()">Export Skills Structure</button>
                            <input type="file" id="skillsImportFile" accept=".json" style="display: none;" onchange="importSkills(event)">
                            <button class="export-btn" style="background: linear-gradient(135deg, #6f42c1, #8b5cf6);" onclick="document.getElementById('skillsImportFile').click()">Import Skills</button>
                        </div>
                    </div>
                </div>

                <!-- Analytics Dashboard -->
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h3>Team Completion</h3>
                        <div class="analytics-number" id="completionRate">0%</div>
                        <div class="analytics-label">Assessments Complete</div>
                    </div>
                    <div class="analytics-card">
                        <h3>Total Assessments</h3>
                        <div class="analytics-number" id="totalAssessments">0</div>
                        <div class="analytics-label">Individual Reviews</div>
                    </div>
                    <div class="analytics-card">
                        <h3>Expert Skills</h3>
                        <div class="analytics-number" id="expertCount">0</div>
                        <div class="analytics-label">Across All Areas</div>
                    </div>
                    <div class="analytics-card">
                        <h3>Skills Gaps</h3>
                        <div class="analytics-number" id="gapsCount">0</div>
                        <div class="analytics-label">Need Development</div>
                    </div>
                </div>
                
                <div class="filters">
                    <div class="filter-group">
                        <label>Role Filter</label>
                        <select id="roleFilter" onchange="applyFilters()">
                            <option value="all">All Roles</option>
                            <option value="supervisor">Supervisors</option>
                            <option value="artist">Artists</option>
                            <option value="lead">Leads</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Skill Category</label>
                        <select id="categoryFilter" onchange="applyFilters()">
                            <option value="all">All Categories</option>
                            <option value="technical">Technical Skills</option>
                            <option value="software">Software</option>
                            <option value="leadership">Leadership</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Skill Level</label>
                        <select id="skillLevelFilter" onchange="applyFilters()">
                            <option value="all">All Levels</option>
                            <option value="expert">Expert Only</option>
                            <option value="gaps">Show Gaps</option>
                        </select>
                    </div>

                    <button class="export-btn" onclick="exportOverview()">Export CSV</button>
                    <button class="export-btn" onclick="generateReport()">Generate Report</button>
                </div>

                <div style="overflow-x: auto;">
                    <table class="overview-table" id="overviewTable">
                        <!-- Table will be populated by JavaScript -->
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto-save indicator -->
    <div id="autoSaveIndicator" class="auto-save-indicator">
        ✓ Auto-saved
    </div>

    <!-- Session info -->
    <div id="sessionInfo" class="session-info" style="display: none;">
        <span>Logged in as: <span id="sessionUser"></span></span>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <script>
        // Sample skills data structure
        let skillsData = {
            "TECHNICAL SKILLS": [
                "Modeling & Sculpting",
                "Texturing & Materials", 
                "Rigging & Character Setup",
                "Animation",
                "VFX & Simulation",
                "Lighting & Shading",
                "Compositing"
            ],
            "SOFTWARE PROFICIENCY": [
                "Maya",
                "Houdini", 
                "Nuke",
                "Unreal Engine",
                "Blender",
                "Katana",
                "Harmony"
            ],
            "RENDERING SYSTEMS": [
                "Arnold",
                "RenderMan",
                "Cycles",
                "Karma"
            ],
            "LEADERSHIP & MANAGEMENT": [
                "Team Leadership",
                "Project Management", 
                "Mentoring & Training",
                "Client Communication",
                "Creative Direction",
                "Budget Management"
            ],
            "TECHNICAL DEVELOPMENT": [
                "Python Scripting",
                "Pipeline Development",
                "MEL Scripting",
                "Technical Documentation"
            ]
        };

        // Employee data extracted from CSV
        const employees = [
            { name: "Chris Barischoff", role: "CG Supervisor" },
            { name: "Ila", role: "CG Supervisor" },
            { name: "Nick Chong", role: "CG Supervisor" },
            { name: "Ben Shepperd", role: "CG Supervisor" },
            { name: "Joseph Li", role: "CG Supervisor" },
            { name: "Natalia", role: "CG Supervisor" },
            { name: "Tamer", role: "Frontend CG Supervisor" },
            { name: "John Saleem", role: "Asset Supervisor" },
            { name: "Rob Lodermeier", role: "Anim Supervisor" }
        ];

        // Store assessment data
        let assessmentData = {};
        let currentEmployee = null;
        let supervisorAccess = false;
        let userSession = null;
        let autoSaveTimeout = null;

        // Supervisor access control
        const supervisorPasswords = {
            'supervisor123': true,
            'admin2024': true,
            'vfxlead': true
        };

        function generatePassword(firstName) {
            const randomNumbers = Math.floor(1000 + Math.random() * 9000);
            return firstName + randomNumbers;
        }

        // Ensure passwords are always set
        function ensurePasswordsExist() {
            employees.forEach(emp => {
                if (!emp.password || emp.password === 'undefined') {
                    const firstName = emp.name.split(' ')[0];
                    emp.password = generatePassword(firstName);
                    console.log(`Generated password for ${emp.name}: ${emp.password}`);
                }
            });
        }

        function saveEmployeesList() {
            try {
                localStorage.setItem('vfxEmployeesList', JSON.stringify(employees));
                console.log('Employees saved to localStorage');
            } catch (error) {
                console.error('Could not save employees list:', error);
                showNotification('Warning: Could not save employees list');
            }
        }

        function loadEmployeesList() {
            try {
                const saved = localStorage.getItem('vfxEmployeesList');
                if (saved) {
                    const loadedEmployees = JSON.parse(saved);
                    console.log('Loaded employees from localStorage:', loadedEmployees);
                    
                    employees.length = 0;
                    loadedEmployees.forEach(emp => {
                        if (!emp.password || emp.password === 'undefined') {
                            const firstName = emp.name.split(' ')[0];
                            emp.password = generatePassword(firstName);
                            console.log(`Generated password for ${emp.name}: ${emp.password}`);
                        }
                        employees.push(emp);
                    });
                    
                    saveEmployeesList();
                } else {
                    console.log('No saved employees, using defaults');
                    ensurePasswordsExist();
                    saveEmployeesList();
                }
            } catch (error) {
                console.log('Could not load employees list:', error);
                ensurePasswordsExist();
            }
        }

        function saveAssessmentData() {
            try {
                localStorage.setItem('vfxSkillsAssessmentData', JSON.stringify(assessmentData));
                console.log('Assessment data saved to localStorage');
                showNotification('✓ Assessment saved successfully');
            } catch (error) {
                console.error('Could not save assessment data:', error);
                showNotification('❌ Failed to save assessment data');
            }
        }

        function loadAssessmentData() {
            try {
                const saved = localStorage.getItem('vfxSkillsAssessmentData');
                if (saved) {
                    assessmentData = JSON.parse(saved);
                    console.log('Loaded assessment data from localStorage:', Object.keys(assessmentData));
                } else {
                    console.log('No saved assessment data found, adding test data');
                    addTestData();
                }
            } catch (error) {
                console.log('Could not load assessment data:', error);
                assessmentData = {};
                addTestData();
            }
            
            // Update UI if needed
            if (supervisorAccess) {
                updateAnalytics();
            }
        }

        function addTestData() {
            console.log('Adding test assessment data...');
            
            // Chris Barischoff - Senior CG Supervisor with strong technical skills
            assessmentData["Chris Barischoff"] = {
                "Modeling & Sculpting": "Advanced",
                "Texturing & Materials": "Expert",
                "Rigging & Character Setup": "Intermediate",
                "Animation": "Intermediate",
                "VFX & Simulation": "Expert",
                "Lighting & Shading": "Expert",
                "Compositing": "Advanced",
                "Maya": "Expert",
                "Houdini": "Expert",
                "Nuke": "Advanced",
                "Unreal Engine": "Intermediate",
                "Blender": "Intermediate",
                "Arnold": "Expert",
                "RenderMan": "Advanced",
                "Team Leadership": "Expert",
                "Project Management": "Advanced",
                "Mentoring & Training": "Expert",
                "Client Communication": "Advanced",
                "Python Scripting": "Advanced",
                "Pipeline Development": "Intermediate"
            };

            // Ila - Strong in compositing and lighting
            assessmentData["Ila"] = {
                "Modeling & Sculpting": "Intermediate",
                "Texturing & Materials": "Advanced",
                "Rigging & Character Setup": "Beginner",
                "Animation": "Advanced",
                "VFX & Simulation": "Advanced",
                "Lighting & Shading": "Expert",
                "Compositing": "Expert",
                "Maya": "Expert",
                "Houdini": "Intermediate",
                "Nuke": "Expert",
                "Unreal Engine": "Beginner",
                "Katana": "Expert",
                "Arnold": "Expert",
                "Cycles": "Advanced",
                "Team Leadership": "Advanced",
                "Mentoring & Training": "Advanced",
                "Client Communication": "Intermediate"
            };

            // Nick Chong - Modeling specialist
            assessmentData["Nick Chong"] = {
                "Modeling & Sculpting": "Expert",
                "Texturing & Materials": "Advanced",
                "Rigging & Character Setup": "Intermediate",
                "Animation": "Beginner",
                "VFX & Simulation": "Intermediate",
                "Lighting & Shading": "Advanced",
                "Compositing": "Intermediate",
                "Maya": "Expert",
                "Houdini": "Intermediate",
                "Nuke": "Intermediate",
                "Blender": "Expert",
                "Arnold": "Advanced",
                "Team Leadership": "Intermediate",
                "Project Management": "Intermediate",
                "Python Scripting": "Beginner"
            };

            // Rob Lodermeier - Animation Supervisor
            assessmentData["Rob Lodermeier"] = {
                "Modeling & Sculpting": "Beginner",
                "Texturing & Materials": "Beginner",
                "Rigging & Character Setup": "Advanced",
                "Animation": "Expert",
                "VFX & Simulation": "Beginner",
                "Lighting & Shading": "Beginner",
                "Compositing": "Beginner",
                "Maya": "Expert",
                "Houdini": "Beginner",
                "Nuke": "Beginner",
                "Unreal Engine": "Advanced",
                "Team Leadership": "Expert",
                "Project Management": "Advanced",
                "Mentoring & Training": "Expert",
                "Client Communication": "Advanced",
                "MEL Scripting": "Advanced"
            };

            // John Saleem - Asset Supervisor (partial completion for testing)
            assessmentData["John Saleem"] = {
                "Modeling & Sculpting": "Expert",
                "Texturing & Materials": "Expert",
                "Rigging & Character Setup": "Intermediate",
                "Maya": "Expert",
                "Houdini": "Advanced",
                "Blender": "Advanced",
                "Arnold": "Expert",
                "Team Leadership": "Advanced",
                "Project Management": "Expert"
                // Intentionally incomplete to show partial progress
            };

            console.log('Test data added for:', Object.keys(assessmentData));
            
            // Save the test data
            saveAssessmentData();
        }

        function updateAnalytics() {
            const totalEmployees = employees.length;
            const completedAssessments = Object.keys(assessmentData).length;
            const completionRate = totalEmployees > 0 ? Math.round((completedAssessments / totalEmployees) * 100) : 0;
            
            // Count expert skills and gaps
            const allSkills = Object.values(skillsData).flat();
            let expertCount = 0;
            let gapsCount = 0;
            
            allSkills.forEach(skill => {
                const ratings = employees.map(emp => 
                    assessmentData[emp.name] && assessmentData[emp.name][skill] || 'not-assessed'
                );
                
                const experts = ratings.filter(r => r === 'Expert').length;
                const assessed = ratings.filter(r => r !== 'not-assessed').length;
                
                expertCount += experts;
                if (experts === 0 && assessed > 0) {
                    gapsCount++;
                }
            });
            
            // Update analytics display
            const completionEl = document.getElementById('completionRate');
            const totalEl = document.getElementById('totalAssessments');
            const expertEl = document.getElementById('expertCount');
            const gapsEl = document.getElementById('gapsCount');
            
            if (completionEl) completionEl.textContent = completionRate + '%';
            if (totalEl) totalEl.textContent = completedAssessments;
            if (expertEl) expertEl.textContent = expertCount;
            if (gapsEl) gapsEl.textContent = gapsCount;
        }

        function addNewEmployee() {
            console.log('Adding new employee...');
            const nameInput = document.getElementById('newEmployeeName');
            const roleInput = document.getElementById('newEmployeeRole');
            
            if (!nameInput || !roleInput) {
                console.error('Form inputs not found');
                showNotification('Form error - please refresh the page');
                return;
            }
            
            const name = nameInput.value.trim();
            const role = roleInput.value;
            
            console.log('Name:', name, 'Role:', role);
            
            if (!name || !role) {
                showNotification('Please enter both name and role');
                return;
            }
            
            // Check if employee already exists
            if (employees.find(emp => emp.name.toLowerCase() === name.toLowerCase())) {
                showNotification('Employee already exists');
                return;
            }
            
            // Generate password (first name + 4 random numbers)
            const firstName = name.split(' ')[0];
            const password = generatePassword(firstName);
            
            console.log('Generated password:', password);
            
            // Add new employee
            const newEmployee = { name, role, password };
            employees.push(newEmployee);
            
            console.log('Updated employees array:', employees);
            
            // Save employees list
            saveEmployeesList();
            
            // Clear form
            nameInput.value = '';
            roleInput.value = '';
            
            // Refresh displays
            populateEmployeeGrid();
            if (supervisorAccess) {
                populateOverview();
                updateAnalytics();
            }
            
            showNotification(`${name} added successfully! Password: ${password}`);
        }

        function requestSupervisorAccess() {
            if (supervisorAccess) {
                showView('overview');
                return;
            }
            
            const password = prompt('Enter supervisor password to access overview: supervisor123');
            
            if (supervisorPasswords[password]) {
                supervisorAccess = true;
                sessionStorage.setItem('supervisorSession', 'true');
                document.querySelectorAll('.supervisor-only').forEach(el => {
                    el.classList.add('visible');
                });
                showView('overview');
                showNotification('Supervisor access granted!');
                updateSessionInfo('Supervisor');
            } else if (password !== null) {
                showNotification('Invalid supervisor password');
            }
        }

        function requestUserLogin(employeeName) {
            return new Promise((resolve, reject) => {
                const employee = employees.find(emp => emp.name === employeeName);
                if (!employee) {
                    reject('Employee not found');
                    return;
                }

                console.log('Employee login request for:', employee);

                // Create password modal
                const overlay = document.createElement('div');
                overlay.className = 'password-overlay';
                
                overlay.innerHTML = `
                    <div class="password-modal">
                        <h3>Welcome ${employee.name}</h3>
                        <div class="password-hint">
                            <strong>Your password is:</strong> ${employee.password || 'Password not set'}
                        </div>
                        <input type="password" id="userPassword" placeholder="Enter your password" maxlength="20">
                        <div>
                            <button class="btn" onclick="verifyUserPassword('${employeeName}')">Login</button>
                            <button class="btn" onclick="closePasswordModal()" style="background: #6c757d;">Cancel</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                document.getElementById('userPassword').focus();
                
                // Store resolve function for later use
                window.currentLoginResolve = resolve;
                window.currentLoginReject = reject;
            });
        }

        function verifyUserPassword(employeeName) {
            const enteredPassword = document.getElementById('userPassword').value;
            const employee = employees.find(emp => emp.name === employeeName);
            
            if (employee && employee.password === enteredPassword) {
                userSession = employeeName;
                sessionStorage.setItem('userSession', employeeName);
                closePasswordModal();
                updateSessionInfo(employeeName);
                window.currentLoginResolve(true);
                showNotification(`Welcome ${employeeName}!`);
            } else {
                showNotification('Incorrect password');
                document.getElementById('userPassword').value = '';
                document.getElementById('userPassword').focus();
            }
        }

        function closePasswordModal() {
            const overlay = document.querySelector('.password-overlay');
            if (overlay) {
                overlay.remove();
            }
            if (window.currentLoginReject) {
                window.currentLoginReject('Login cancelled');
            }
        }

        function logout() {
            // Clear all sessions
            supervisorAccess = false;
            userSession = null;
            
            // Clear session storage
            sessionStorage.removeItem('supervisorSession');
            sessionStorage.removeItem('userSession');
            
            // Hide supervisor buttons
            document.querySelectorAll('.supervisor-only').forEach(el => {
                el.classList.remove('visible');
            });
            
            // Hide session info
            document.getElementById('sessionInfo').style.display = 'none';
            
            // Go back to home
            showView('home');
            
            // Show notification
            showNotification('Logged out successfully');
            
            console.log('User logged out');
        }

        function updateSessionInfo(user) {
            const sessionInfo = document.getElementById('sessionInfo');
            const sessionUser = document.getElementById('sessionUser');
            sessionUser.textContent = user;
            sessionInfo.style.display = 'flex';
        }

        function checkExistingSessions() {
            // Check for existing supervisor session
            if (sessionStorage.getItem('supervisorSession')) {
                supervisorAccess = true;
                document.querySelectorAll('.supervisor-only').forEach(el => {
                    el.classList.add('visible');
                });
                updateSessionInfo('Supervisor');
            }
            
            // Check for existing user session
            const savedUserSession = sessionStorage.getItem('userSession');
            if (savedUserSession) {
                userSession = savedUserSession;
                updateSessionInfo(savedUserSession);
            }
        }

        // Initialize the application
        async function initializeApp() {
            console.log('Initializing app...');
            console.log('Default employees:', employees);
            
            // Load skills first
            loadSkillsData();
            
            // Ensure passwords exist before loading
            ensurePasswordsExist();
            
            await loadEmployeesList();
            console.log('After loading employees:', employees);
            
            await loadAssessmentData();
            checkExistingSessions();
            
            // Small delay to ensure DOM is ready
            setTimeout(() => {
                populateEmployeeGrid();
                updateSkillCategoryDropdown();
            }, 100);
        }

        function populateEmployeeGrid() {
            console.log('Populating employee grid with:', employees);
            const grid = document.getElementById('employeeGrid');
            
            if (!employees || employees.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;"><h3>No team members found</h3><p>Supervisors can add new team members from the overview page.</p></div>';
                return;
            }
            
            grid.innerHTML = '';

            employees.forEach((employee, index) => {
                console.log(`Creating card for employee ${index}:`, employee);
                const completion = getCompletionStatus(employee.name);
                const card = document.createElement('div');
                card.className = 'employee-card';
                card.onclick = () => handleEmployeeSelection(employee.name, employee.role);
                
                card.innerHTML = `
                    <div class="employee-name">${employee.name}</div>
                    <div class="employee-role">${employee.role}</div>
                    <div class="completion-status ${completion.class}">${completion.text}</div>
                `;
                
                grid.appendChild(card);
            });
            
            console.log(`Employee grid populated with ${employees.length} employees`);
        }

        async function handleEmployeeSelection(employeeName, employeeRole) {
            // Don't allow employee login if supervisor is logged in
            if (supervisorAccess) {
                showNotification('Please logout of supervisor mode first to access employee assessments');
                return;
            }
            
            try {
                // Check if user is already logged in as this employee
                if (userSession === employeeName) {
                    startAssessment(employeeName, employeeRole);
                    return;
                }
                
                // Request login
                await requestUserLogin(employeeName);
                startAssessment(employeeName, employeeRole);
            } catch (error) {
                console.log('Login cancelled or failed:', error);
            }
        }

        function getCompletionStatus(employeeName) {
            const data = assessmentData[employeeName];
            if (!data) return { class: 'not-started', text: 'Not Started' };
            
            const totalSkills = Object.values(skillsData).flat().length;
            const completedSkills = Object.keys(data).length;
            const percentage = (completedSkills / totalSkills) * 100;
            
            if (percentage === 100) return { class: 'completed', text: 'Completed' };
            if (percentage > 0) return { class: 'pending', text: `${Math.round(percentage)}% Complete` };
            return { class: 'not-started', text: 'Not Started' };
        }

        function startAssessment(employeeName, employeeRole) {
            currentEmployee = employeeName;
            document.getElementById('currentEmployee').textContent = `${employeeName} - ${employeeRole}`;
            
            populateAssessmentForm();
            updateProgress();
            showView('assessment');
        }

        function populateAssessmentForm() {
            const container = document.getElementById('skillsSections');
            container.innerHTML = '';

            Object.entries(skillsData).forEach(([category, skills]) => {
                const section = document.createElement('div');
                section.className = 'skills-section';
                
                const categoryClass = category.toLowerCase().replace(/[^a-z]/g, '');
                section.innerHTML = `
                    <div class="section-title">${category}</div>
                    <div class="skills-grid">
                        ${skills.map(skill => `
                            <div class="skill-row">
                                <div class="skill-name">${skill}</div>
                                <div class="rating-buttons">
                                    <button class="rating-btn beginner" onclick="selectRating('${skill}', 'Beginner')">Beginner</button>
                                    <button class="rating-btn intermediate" onclick="selectRating('${skill}', 'Intermediate')">Intermediate</button>
                                    <button class="rating-btn advanced" onclick="selectRating('${skill}', 'Advanced')">Advanced</button>
                                    <button class="rating-btn expert" onclick="selectRating('${skill}', 'Expert')">Expert</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(section);
            });

            // Load existing ratings
            loadCurrentRatings();
        }

        function loadCurrentRatings() {
            if (!currentEmployee || !assessmentData[currentEmployee]) return;
            
            const data = assessmentData[currentEmployee];
            Object.entries(data).forEach(([skill, rating]) => {
                const buttons = document.querySelectorAll(`button[onclick*="${skill}"]`);
                buttons.forEach(btn => {
                    btn.classList.remove('selected');
                    if (btn.textContent === rating) {
                        btn.classList.add('selected');
                    }
                });
            });
        }

        function selectRating(skill, rating) {
            // Initialize employee data if it doesn't exist
            if (!assessmentData[currentEmployee]) {
                assessmentData[currentEmployee] = {};
            }
            
            // Save the rating
            assessmentData[currentEmployee][skill] = rating;
            
            // Update button states
            const buttons = document.querySelectorAll(`button[onclick*="${skill}"]`);
            buttons.forEach(btn => {
                btn.classList.remove('selected');
                if (btn.textContent === rating) {
                    btn.classList.add('selected');
                }
            });
            
            // Update progress
            updateProgress();
            
            // Auto-save with debouncing
            autoSaveAssessment();
        }

        function autoSaveAssessment() {
            // Clear existing timeout
            if (autoSaveTimeout) {
                clearTimeout(autoSaveTimeout);
            }
            
            // Set new timeout for auto-save
            autoSaveTimeout = setTimeout(() => {
                saveAssessmentData();
                showAutoSaveIndicator();
            }, 1000); // Auto-save after 1 second of inactivity
        }

        function showAutoSaveIndicator() {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.classList.add('show');
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        function updateProgress() {
            if (!currentEmployee) return;
            
            const totalSkills = Object.values(skillsData).flat().length;
            const completedSkills = assessmentData[currentEmployee] ? Object.keys(assessmentData[currentEmployee]).length : 0;
            const percentage = (completedSkills / totalSkills) * 100;
            
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = Math.round(percentage) + '% Complete';
        }

        function saveAssessment() {
            if (!currentEmployee) return;
            
            saveAssessmentData();
            showNotification('Assessment saved successfully!');
            showView('home');
            populateEmployeeGrid(); // Refresh completion status
        }

        function showView(viewName) {
            // Check supervisor access for overview
            if (viewName === 'overview' && !supervisorAccess) {
                requestSupervisorAccess();
                return;
            }
            
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            
            // Show selected view
            document.getElementById(viewName).classList.add('active');
            
            // Update nav buttons
            document.querySelectorAll('.btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find and activate the correct button
            const targetBtn = Array.from(document.querySelectorAll('.btn')).find(btn => 
                btn.textContent.toLowerCase().includes(viewName === 'home' ? 'home' : 
                viewName === 'assessment' ? 'assessment' : 'overview')
            );
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
            
            // Populate overview if needed
            if (viewName === 'overview') {
                populateOverview();
                updateAnalytics();
                updateCategoryFilterDropdown();
            }
        }

        function updateCategoryFilterDropdown() {
            const dropdown = document.getElementById('categoryFilter');
            if (!dropdown) return;
            
            // Store current value
            const currentValue = dropdown.value;
            
            // Clear and rebuild options
            dropdown.innerHTML = '<option value="all">All Categories</option>';
            
            // Add dynamic categories
            Object.keys(skillsData).forEach(category => {
                const option = document.createElement('option');
                const simplifiedValue = category.toLowerCase().replace(/[^a-z]/g, '');
                option.value = simplifiedValue;
                option.textContent = category;
                dropdown.appendChild(option);
            });
            
            // Restore previous selection if still valid
            if (currentValue && Array.from(dropdown.options).some(opt => opt.value === currentValue)) {
                dropdown.value = currentValue;
            }
        }

        function populateOverview() {
            const table = document.getElementById('overviewTable');
            const allSkills = Object.values(skillsData).flat();
            
            // Create header
            let headerHTML = '<thead><tr><th>Skills & Competencies</th>';
            employees.forEach(emp => {
                headerHTML += `<th style="writing-mode: vertical-rl; text-orientation: mixed; min-width: 100px;">${emp.name}<br><small>${emp.role}</small></th>`;
            });
            headerHTML += '</tr></thead>';
            
            // Create body with sections
            let bodyHTML = '<tbody>';
            Object.entries(skillsData).forEach(([category, skills]) => {
                // Section header
                bodyHTML += `<tr><td colspan="${employees.length + 1}" style="background: #6c757d; color: white; font-weight: bold; padding: 15px 20px;">${category}</td></tr>`;
                
                // Skills rows
                skills.forEach(skill => {
                    bodyHTML += `<tr class="skill-row-overview" data-skill="${skill}" data-category="${category}"><td>${skill}</td>`;
                    employees.forEach(emp => {
                        const rating = assessmentData[emp.name] && assessmentData[emp.name][skill] || 'not-assessed';
                        const ratingClass = rating.toLowerCase().replace(' ', '-');
                        bodyHTML += `<td><span class="skill-rating ${ratingClass}">${rating === 'not-assessed' ? 'N/A' : rating}</span></td>`;
                    });
                    bodyHTML += '</tr>';
                });
            });
            bodyHTML += '</tbody>';
            
            table.innerHTML = headerHTML + bodyHTML;
        }

        function applyFilters() {
            const roleFilter = document.getElementById('roleFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const skillLevelFilter = document.getElementById('skillLevelFilter').value;
            
            const rows = document.querySelectorAll('.skill-row-overview');
            const headers = document.querySelectorAll('#overviewTable th');
            
            // Show/hide columns based on role filter
            headers.forEach((header, index) => {
                if (index === 0) return; // Skip first column (skills)
                
                const employeeIndex = index - 1;
                const employee = employees[employeeIndex];
                let showColumn = true;
                
                if (roleFilter !== 'all') {
                    const role = employee.role.toLowerCase();
                    showColumn = role.includes(roleFilter.toLowerCase());
                }
                
                header.style.display = showColumn ? '' : 'none';
                
                // Hide corresponding cells in all rows
                document.querySelectorAll(`#overviewTable td:nth-child(${index + 1})`).forEach(cell => {
                    cell.style.display = showColumn ? '' : 'none';
                });
            });
            
            // Show/hide rows based on category and skill level filters
            rows.forEach(row => {
                let showRow = true;
                
                if (categoryFilter !== 'all') {
                    const category = row.dataset.category;
                    const simplifiedFilter = categoryFilter.toLowerCase();
                    const simplifiedCategory = category.toLowerCase().replace(/[^a-z]/g, '');
                    showRow = simplifiedCategory.includes(simplifiedFilter) || category.toLowerCase().includes(simplifiedFilter);
                }
                
                if (skillLevelFilter !== 'all' && showRow) {
                    const ratings = Array.from(row.querySelectorAll('.skill-rating')).map(span => span.textContent.toLowerCase());
                    
                    if (skillLevelFilter === 'expert') {
                        showRow = ratings.includes('expert');
                    } else if (skillLevelFilter === 'gaps') {
                        showRow = ratings.includes('n/a') || ratings.filter(r => r === 'beginner').length > ratings.length / 2;
                    }
                }
                
                row.style.display = showRow ? '' : 'none';
            });
            
            showNotification('Filters applied successfully!');
        }

        function exportOverview() {
            const table = document.getElementById('overviewTable');
            let csv = [];
            
            // Get visible headers
            const headers = [];
            table.querySelectorAll('thead th').forEach(th => {
                if (th.style.display !== 'none') {
                    headers.push('"' + th.textContent.replace(/"/g, '""').replace(/\n/g, ' ') + '"');
                }
            });
            csv.push(headers.join(','));
            
            // Get visible data rows
            table.querySelectorAll('tbody tr').forEach(tr => {
                if (tr.style.display !== 'none') {
                    const row = [];
                    tr.querySelectorAll('td').forEach((td, index) => {
                        if (td.style.display !== 'none') {
                            let cellText = td.textContent.trim();
                            if (td.querySelector('.skill-rating')) {
                                cellText = td.querySelector('.skill-rating').textContent.trim();
                            }
                            row.push('"' + cellText.replace(/"/g, '""') + '"');
                        }
                    });
                    if (row.length > 0) {
                        csv.push(row.join(','));
                    }
                }
            });
            
            // Download CSV
            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'skills_overview_' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showNotification('Overview exported successfully!');
        }

        function generateReport() {
            const matrix = analyzeOverviewData();
            
            const reportHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Skills Assessment Analysis Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.6; max-width: 1200px; margin: 0 auto; }
                        .header { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6; }
                        .section { margin-bottom: 30px; }
                        .skill-gap { background: #fff3cd; padding: 10px; margin: 5px 0; border-radius: 4px; border-left: 4px solid #ffc107; }
                        .strength { background: #d4edda; padding: 10px; margin: 5px 0; border-radius: 4px; border-left: 4px solid #28a745; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background: #f8f9fa; font-weight: 600; }
                        .risk-high { background: #f8d7da !important; }
                        .risk-medium { background: #fff3cd !important; }
                        .risk-low { background: #d4edda !important; }
                        h1 { color: #2c3e50; margin-bottom: 10px; }
                        h2 { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 5px; }
                        h3 { color: #2c3e50; }
                        .summary-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
                        .stat-card { background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; text-align: center; }
                        .stat-number { font-size: 2em; font-weight: bold; color: #007bff; }
                        .print-btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 10px 0; }
                        @media print { .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Skills Assessment Analysis Report</h1>
                        <p><strong>Generated on:</strong> ${new Date().toLocaleDateString()}</p>
                        <p><strong>Team Size:</strong> ${matrix.totalEmployees} members</p>
                        <p><strong>Assessment Completion:</strong> ${matrix.completionRate}%</p>
                        <button class="print-btn no-print" onclick="window.print()">Print Report</button>
                    </div>
                    
                    <div class="summary-stats">
                        <div class="stat-card">
                            <div class="stat-number">${matrix.totalSkills}</div>
                            <div>Skills Assessed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${matrix.strengths.length}</div>
                            <div>Team Strengths</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${matrix.gaps.length}</div>
                            <div>Critical Gaps</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${matrix.expertCount}</div>
                            <div>Expert Ratings</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>Executive Summary</h2>
                        <p>This comprehensive analysis evaluates ${matrix.totalAssessments} individual skill assessments across ${matrix.totalSkills} competencies covering technical expertise, software proficiency, and leadership capabilities.</p>
                        
                        <h3>Key Findings:</h3>
                        <ul>
                            <li><strong>Assessment Participation:</strong> ${matrix.completionRate}% of team members have completed their assessments</li>
                            <li><strong>Team Strengths:</strong> ${matrix.strengths.length > 0 ? matrix.strengths.join(', ') : 'Assessment data needed'}</li>
                            <li><strong>Development Areas:</strong> ${matrix.gaps.length > 0 ? matrix.gaps.join(', ') : 'No critical gaps identified'}</li>
                            <li><strong>Training Priority:</strong> ${matrix.trainingPriority}</li>
                        </ul>
                    </div>
                    
                    <div class="section">
                        <h2>Detailed Analysis by Category</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Skill Category</th>
                                    <th>Expert</th>
                                    <th>Advanced</th>
                                    <th>Intermediate</th>
                                    <th>Beginner</th>
                                    <th>Not Assessed</th>
                                    <th>Risk Level</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${matrix.categoryBreakdown.map(cat => `
                                    <tr>
                                        <td><strong>${cat.category}</strong></td>
                                        <td>${cat.expert}</td>
                                        <td>${cat.advanced}</td>
                                        <td>${cat.intermediate}</td>
                                        <td>${cat.beginner}</td>
                                        <td>${cat.notAssessed}</td>
                                        <td class="risk-${cat.risk.toLowerCase()}">${cat.risk}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="section">
                        <h2>Individual Skill Breakdown</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Skill</th>
                                    <th>Expert</th>
                                    <th>Advanced</th>
                                    <th>Intermediate</th>
                                    <th>Beginner</th>
                                    <th>Coverage</th>
                                    <th>Priority</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${matrix.skillBreakdown.map(skill => `
                                    <tr>
                                        <td>${skill.name}</td>
                                        <td>${skill.expert}</td>
                                        <td>${skill.advanced}</td>
                                        <td>${skill.intermediate}</td>
                                        <td>${skill.beginner}</td>
                                        <td>${skill.coverage}%</td>
                                        <td class="risk-${skill.priority.toLowerCase()}">${skill.priority}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="section">
                        <h2>Strategic Recommendations</h2>
                        
                        <h3>🚨 Immediate Actions (0-3 months):</h3>
                        ${matrix.recommendations.immediate.map(rec => `<div class="skill-gap">• ${rec}</div>`).join('')}
                        
                        <h3>📈 Medium-term Development (3-12 months):</h3>
                        ${matrix.recommendations.mediumTerm.map(rec => `<div class="strength">• ${rec}</div>`).join('')}
                        
                        <h3>🎯 Long-term Strategic Goals (12+ months):</h3>
                        ${matrix.recommendations.longTerm.map(rec => `<div class="strength">• ${rec}</div>`).join('')}
                    </div>
                    
                    <div class="section">
                        <h2>Team Development Priorities</h2>
                        ${matrix.individualRecommendations.map(person => `
                            <div style="border-left: 4px solid #007bff; padding-left: 15px; margin-bottom: 20px;">
                                <h4>${person.name} (${person.role})</h4>
                                <p><strong>Assessment Status:</strong> ${person.status}</p>
                                <p><strong>Key Strengths:</strong> ${person.strengths.length > 0 ? person.strengths.join(', ') : 'Assessment pending'}</p>
                                <p><strong>Development Areas:</strong> ${person.developmentAreas.length > 0 ? person.developmentAreas.join(', ') : 'Assessment pending'}</p>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="section">
                        <h2>Action Plan</h2>
                        <ol>
                            <li><strong>Complete Outstanding Assessments</strong> - ${100 - matrix.completionRate}% of team members still need to complete their assessments</li>
                            <li><strong>Implement Training Programs</strong> - Focus on identified gap areas and skill development priorities</li>
                            <li><strong>Establish Mentoring Networks</strong> - Pair expert-level team members with those developing skills</li>
                            <li><strong>Regular Review Cycles</strong> - Schedule quarterly skills assessment updates</li>
                            <li><strong>Track Progress Metrics</strong> - Monitor skill development and training effectiveness</li>
                        </ol>
                    </div>
                </body>
                </html>
            `;
            
            // Download as HTML file
            const blob = new Blob([reportHTML], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'skills_analysis_report_' + new Date().toISOString().split('T')[0] + '.html';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showNotification('Comprehensive analysis report generated!');
        }

        function analyzeOverviewData() {
            const allSkills = Object.values(skillsData).flat();
            const totalEmployees = employees.length;
            const completedAssessments = Object.keys(assessmentData).length;
            const completionRate = Math.round((completedAssessments / totalEmployees) * 100);
            
            let totalAssessments = 0;
            let expertCount = 0;
            const skillBreakdown = [];
            const categoryBreakdown = [];
            
            // Analyze each skill
            allSkills.forEach(skill => {
                const ratings = employees.map(emp => 
                    assessmentData[emp.name] && assessmentData[emp.name][skill] || 'not-assessed'
                );
                
                const counts = {
                    expert: ratings.filter(r => r === 'Expert').length,
                    advanced: ratings.filter(r => r === 'Advanced').length,
                    intermediate: ratings.filter(r => r === 'Intermediate').length,
                    beginner: ratings.filter(r => r === 'Beginner').length,
                    notAssessed: ratings.filter(r => r === 'not-assessed').length
                };
                
                const assessed = totalEmployees - counts.notAssessed;
                const coverage = assessed > 0 ? Math.round(((counts.expert + counts.advanced) / assessed) * 100) : 0;
                
                let priority = 'Low';
                if (counts.expert === 0 && assessed > 0) priority = 'High';
                else if (coverage < 30) priority = 'Medium';
                
                skillBreakdown.push({
                    name: skill,
                    ...counts,
                    coverage,
                    priority
                });
                
                expertCount += counts.expert;
                totalAssessments += assessed;
            });
            
            // Analyze by category
            Object.entries(skillsData).forEach(([category, skills]) => {
                const categoryRatings = skills.flatMap(skill => 
                    employees.map(emp => 
                        assessmentData[emp.name] && assessmentData[emp.name][skill] || 'not-assessed'
                    )
                );
                
                const counts = {
                    expert: categoryRatings.filter(r => r === 'Expert').length,
                    advanced: categoryRatings.filter(r => r === 'Advanced').length,
                    intermediate: categoryRatings.filter(r => r === 'Intermediate').length,
                    beginner: categoryRatings.filter(r => r === 'Beginner').length,
                    notAssessed: categoryRatings.filter(r => r === 'not-assessed').length
                };
                
                const assessed = categoryRatings.length - counts.notAssessed;
                const expertPercent = assessed > 0 ? (counts.expert / assessed) * 100 : 0;
                
                let risk = 'Low';
                if (expertPercent < 10) risk = 'High';
                else if (expertPercent < 25) risk = 'Medium';
                
                categoryBreakdown.push({
                    category,
                    ...counts,
                    risk
                });
            });
            
            // Identify strengths, gaps, and priorities
            const strengths = skillBreakdown.filter(s => s.expert >= 2).map(s => s.name);
            const gaps = skillBreakdown.filter(s => s.expert === 0 && s.notAssessed < totalEmployees).map(s => s.name);
            const trainingPriority = gaps.length > 0 ? gaps[0] : 'Continue skill development across all areas';
            
            // Individual recommendations
            const individualRecommendations = employees.map(emp => {
                const empData = assessmentData[emp.name] || {};
                const empSkills = Object.entries(empData);
                const strengths = empSkills.filter(([_, rating]) => rating === 'Expert').map(([skill]) => skill);
                const developmentAreas = empSkills.filter(([_, rating]) => rating === 'Beginner').map(([skill]) => skill);
                const status = empSkills.length > 0 ? 'Completed' : 'Pending';
                
                return {
                    name: emp.name,
                    role: emp.role,
                    status,
                    strengths: strengths.slice(0, 3),
                    developmentAreas: developmentAreas.slice(0, 3)
                };
            });
            
            return {
                totalEmployees,
                totalSkills: allSkills.length,
                totalAssessments,
                completionRate,
                expertCount,
                skillBreakdown,
                categoryBreakdown,
                strengths: strengths.slice(0, 5),
                gaps: gaps.slice(0, 5),
                trainingPriority,
                individualRecommendations,
                recommendations: {
                    immediate: [
                        `Encourage ${totalEmployees - completedAssessments} team members to complete their assessments`,
                        'Identify training needs for high-priority skill gaps',
                        'Establish peer learning groups for knowledge sharing'
                    ],
                    mediumTerm: [
                        'Develop structured training programs for identified gaps',
                        'Create mentoring relationships between experts and learners',
                        'Implement regular skills assessment cycles'
                    ],
                    longTerm: [
                        'Build center of excellence for critical technical skills',
                        'Develop internal certification programs',
                        'Create comprehensive knowledge management system'
                    ]
                }
            };
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #2E86AB, #A23B72);
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(46, 134, 171, 0.3);
                z-index: 1000;
                font-weight: 600;
                transform: translateX(300px);
                transition: transform 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => notification.style.transform = 'translateX(0)', 100);
            
            // Hide and remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(300px)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Skills Management Functions
        function loadSkillsData() {
            try {
                const saved = localStorage.getItem('vfxSkillsStructure');
                if (saved) {
                    const loadedSkills = JSON.parse(saved);
                    console.log('Loaded skills structure from localStorage');
                    skillsData = loadedSkills;
                } else {
                    console.log('Using default skills structure');
                    saveSkillsData();
                }
            } catch (error) {
                console.error('Could not load skills structure:', error);
            }
        }

        function saveSkillsData() {
            try {
                localStorage.setItem('vfxSkillsStructure', JSON.stringify(skillsData));
                console.log('Skills structure saved');
            } catch (error) {
                console.error('Could not save skills structure:', error);
            }
        }

        function updateSkillCategoryDropdown() {
            const dropdown = document.getElementById('skillCategory');
            if (!dropdown) return;
            
            dropdown.innerHTML = '<option value="">Select Category</option>';
            Object.keys(skillsData).forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                dropdown.appendChild(option);
            });
        }

        function addNewSkill() {
            const categorySelect = document.getElementById('skillCategory');
            const skillInput = document.getElementById('newSkillName');
            
            const category = categorySelect.value;
            const skillName = skillInput.value.trim();
            
            if (!category || !skillName) {
                showNotification('Please select a category and enter a skill name');
                return;
            }
            
            // Check if skill already exists in this category
            if (skillsData[category].includes(skillName)) {
                showNotification('This skill already exists in the selected category');
                return;
            }
            
            // Add the skill
            skillsData[category].push(skillName);
            saveSkillsData();
            
            // Clear form
            skillInput.value = '';
            
            // Update any active views
            if (currentEmployee) {
                populateAssessmentForm();
                loadCurrentRatings();
            }
            
            if (supervisorAccess) {
                populateOverview();
            }
            
            showNotification(`Added "${skillName}" to ${category}`);
        }

        function addNewCategory() {
            const categoryInput = document.getElementById('newCategoryName');
            const categoryName = categoryInput.value.trim().toUpperCase();
            
            if (!categoryName) {
                showNotification('Please enter a category name');
                return;
            }
            
            if (skillsData[categoryName]) {
                showNotification('This category already exists');
                return;
            }
            
            // Add new category with empty skills array
            skillsData[categoryName] = [];
            saveSkillsData();
            
            // Clear form and update dropdown
            categoryInput.value = '';
            updateSkillCategoryDropdown();
            
            showNotification(`Added new category: ${categoryName}`);
        }

        function exportSkills() {
            const skillsExport = JSON.stringify(skillsData, null, 2);
            const blob = new Blob([skillsExport], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'skills_structure_' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showNotification('Skills structure exported successfully!');
        }

        function importSkills(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedSkills = JSON.parse(e.target.result);
                    
                    // Validate structure
                    if (typeof importedSkills !== 'object') {
                        throw new Error('Invalid skills structure');
                    }
                    
                    // Confirm import
                    const totalCategories = Object.keys(importedSkills).length;
                    const totalSkills = Object.values(importedSkills).flat().length;
                    
                    if (confirm(`Import ${totalCategories} categories with ${totalSkills} total skills? This will replace current skills structure.`)) {
                        skillsData = importedSkills;
                        saveSkillsData();
                        updateSkillCategoryDropdown();
                        
                        // Refresh current views
                        if (currentEmployee) {
                            populateAssessmentForm();
                            loadCurrentRatings();
                        }
                        
                        if (supervisorAccess) {
                            populateOverview();
                        }
                        
                        showNotification('Skills imported successfully!');
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    showNotification('Failed to import skills: Invalid file format');
                }
            };
            
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }

        // Employee Bulk Management Functions
        function exportEmployees() {
            // Create CSV content
            let csv = ['Name,Role,Password'];
            
            employees.forEach(emp => {
                csv.push(`"${emp.name}","${emp.role}","${emp.password || ''}"`);
            });
            
            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'employees_export_' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showNotification('Employees exported successfully!');
        }

        function exportEmployeeTemplate() {
            const template = 'Name,Role,Password\n"John Doe","CG Supervisor",""\n"Jane Smith","Lead Artist",""\n"Bob Johnson","Senior Artist",""';
            
            const blob = new Blob([template], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'employees_template.csv';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showNotification('Template downloaded! Fill it out and import.');
        }

        function importEmployees(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            if (file.name.endsWith('.json')) {
                reader.onload = function(e) {
                    try {
                        const importedEmployees = JSON.parse(e.target.result);
                        processImportedEmployees(importedEmployees);
                    } catch (error) {
                        console.error('JSON import error:', error);
                        showNotification('Failed to import: Invalid JSON format');
                    }
                };
                reader.readAsText(file);
            } else {
                // CSV import
                reader.onload = function(e) {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    
                    if (!headers.includes('Name') || !headers.includes('Role')) {
                        showNotification('CSV must have Name and Role columns');
                        return;
                    }
                    
                    const nameIndex = headers.indexOf('Name');
                    const roleIndex = headers.indexOf('Role');
                    const passwordIndex = headers.indexOf('Password');
                    
                    const importedEmployees = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        // Parse CSV line (handle quoted values)
                        const values = line.match(/(".*?"|[^,]+)/g) || [];
                        const cleanValues = values.map(v => v.trim().replace(/^"|"$/g, ''));
                        
                        const name = cleanValues[nameIndex];
                        const role = cleanValues[roleIndex];
                        const password = passwordIndex >= 0 ? cleanValues[passwordIndex] : '';
                        
                        if (name && role) {
                            importedEmployees.push({ name, role, password });
                        }
                    }
                    
                    processImportedEmployees(importedEmployees);
                };
                reader.readAsText(file);
            }
            
            event.target.value = ''; // Reset file input
        }

        function processImportedEmployees(importedEmployees) {
            if (!Array.isArray(importedEmployees) || importedEmployees.length === 0) {
                showNotification('No valid employees found in file');
                return;
            }
            
            let added = 0;
            let updated = 0;
            
            importedEmployees.forEach(emp => {
                if (!emp.name || !emp.role) return;
                
                const existingIndex = employees.findIndex(e => 
                    e.name.toLowerCase() === emp.name.toLowerCase()
                );
                
                if (existingIndex >= 0) {
                    // Update existing employee
                    employees[existingIndex].role = emp.role;
                    if (emp.password) {
                        employees[existingIndex].password = emp.password;
                    }
                    updated++;
                } else {
                    // Add new employee
                    const newEmployee = {
                        name: emp.name,
                        role: emp.role,
                        password: emp.password || generatePassword(emp.name.split(' ')[0])
                    };
                    employees.push(newEmployee);
                    added++;
                }
            });
            
            saveEmployeesList();
            populateEmployeeGrid();
            
            if (supervisorAccess) {
                populateOverview();
                updateAnalytics();
            }
            
            showNotification(`Import complete! Added: ${added}, Updated: ${updated}`);
        }

        // Google Sheets Configuration - REPLACE THESE VALUES!
        const SHEET_CONFIG = {
            spreadsheetId: '1kKMRLcdssEYlN6-5IpxBzStlxeeycCcopfPpY2ClA7I',
            clientId: '191986606094-ul1mrv5rree7e1tpnderpk4a02drpqak.apps.googleusercontent.com',
            apiKey: 'AIzaSyDmoZZEDYmibuxFxF4x_8s90R6BrZ6fvdA',
            discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            scopes: 'https://www.googleapis.com/auth/spreadsheets'
        };

        // Google Sheets Integration Module
        const GoogleSheetsDB = {
            isInitialized: false,
            isSignedIn: false,
            
            // Initialize Google API
            init: async function() {
                return new Promise((resolve, reject) => {
                    gapi.load('client:auth2', async () => {
                        try {
                            await gapi.client.init({
                                apiKey: SHEET_CONFIG.apiKey,
                                clientId: SHEET_CONFIG.clientId,
                                discoveryDocs: SHEET_CONFIG.discoveryDocs,
                                scope: SHEET_CONFIG.scopes
                            });
                            
                            // Listen for sign-in state changes
                            gapi.auth2.getAuthInstance().isSignedIn.listen((isSignedIn) => {
                                this.isSignedIn = isSignedIn;
                                this.updateSignInStatus();
                            });
                            
                            // Handle initial sign-in state
                            this.isSignedIn = gapi.auth2.getAuthInstance().isSignedIn.get();
                            this.updateSignInStatus();
                            
                            this.isInitialized = true;
                            console.log('Google Sheets API initialized');
                            resolve();
                        } catch (error) {
                            console.error('Error initializing Google API:', error);
                            reject(error);
                        }
                    });
                });
            },
            
            // Update UI based on sign-in status
            updateSignInStatus: function() {
                const signInBtn = document.getElementById('googleSignInBtn');
                if (signInBtn) {
                    signInBtn.textContent = this.isSignedIn ? 'Sync: ON ✓' : 'Enable Sync';
                    signInBtn.style.background = this.isSignedIn ? '#34a853' : '#4285f4';
                    if (this.isSignedIn) {
                        showNotification('Connected to Google Sheets - Data will sync automatically');
                        // Load data from Sheets
                        loadEmployeesFromSheets();
                        loadAssessmentsFromSheets();
                    }
                }
            },
            
            // Sign in to Google
            signIn: function() {
                if (!gapi.auth2.getAuthInstance().isSignedIn.get()) {
                    gapi.auth2.getAuthInstance().signIn();
                }
            },
            
            // Sign out from Google
            signOut: function() {
                if (gapi.auth2.getAuthInstance().isSignedIn.get()) {
                    gapi.auth2.getAuthInstance().signOut();
                }
            },
            
            // Read data from a sheet
            readSheet: async function(range) {
                try {
                    const response = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: SHEET_CONFIG.spreadsheetId,
                        range: range
                    });
                    return response.result.values || [];
                } catch (error) {
                    console.error('Error reading sheet:', error);
                    return [];
                }
            },
            
            // Write data to a sheet
            writeSheet: async function(range, values) {
                try {
                    const response = await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: SHEET_CONFIG.spreadsheetId,
                        range: range,
                        valueInputOption: 'RAW',
                        resource: { values: values }
                    });
                    return response.result;
                } catch (error) {
                    console.error('Error writing to sheet:', error);
                    throw error;
                }
            },
            
            // Append data to a sheet
            appendSheet: async function(range, values) {
                try {
                    const response = await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: SHEET_CONFIG.spreadsheetId,
                        range: range,
                        valueInputOption: 'RAW',
                        insertDataOption: 'INSERT_ROWS',
                        resource: { values: values }
                    });
                    return response.result;
                } catch (error) {
                    console.error('Error appending to sheet:', error);
                    throw error;
                }
            },
            
            // Clear a range
            clearSheet: async function(range) {
                try {
                    const response = await gapi.client.sheets.spreadsheets.values.clear({
                        spreadsheetId: SHEET_CONFIG.spreadsheetId,
                        range: range
                    });
                    return response.result;
                } catch (error) {
                    console.error('Error clearing sheet:', error);
                    throw error;
                }
            }
        };

        // Load employees from Google Sheets
        async function loadEmployeesFromSheets() {
            if (!GoogleSheetsDB.isSignedIn) return;
            
            try {
                showNotification('Loading employees from Google Sheets...');
                const data = await GoogleSheetsDB.readSheet('Employees!A2:D');
                
                if (data.length > 0) {
                    employees.length = 0; // Clear current array
                    
                    data.forEach(row => {
                        if (row[0]) { // If name exists
                            employees.push({
                                name: row[0],
                                role: row[1] || '',
                                password: row[2] || generatePassword(row[0].split(' ')[0]),
                                email: row[3] || ''
                            });
                        }
                    });
                    
                    console.log('Loaded employees from Google Sheets:', employees.length);
                    saveEmployeesList(); // Save to localStorage as backup
                    populateEmployeeGrid();
                }
            } catch (error) {
                console.error('Failed to load employees from Sheets:', error);
                showNotification('Failed to load from Google Sheets - using local data');
            }
        }

        // Save all employees to Google Sheets
        async function saveEmployeesToSheets() {
            if (!GoogleSheetsDB.isSignedIn) return;
            
            try {
                // Clear existing data (except header)
                await GoogleSheetsDB.clearSheet('Employees!A2:D');
                
                // Prepare data
                const values = employees.map(emp => [
                    emp.name,
                    emp.role,
                    emp.password || '',
                    emp.email || ''
                ]);
                
                // Write new data
                if (values.length > 0) {
                    await GoogleSheetsDB.writeSheet('Employees!A2:D', values);
                    console.log('Employees synced to Google Sheets');
                }
            } catch (error) {
                console.error('Failed to save employees to Sheets:', error);
            }
        }

        // Load assessments from Google Sheets
        async function loadAssessmentsFromSheets() {
            if (!GoogleSheetsDB.isSignedIn) return;
            
            try {
                showNotification('Loading assessments from Google Sheets...');
                const data = await GoogleSheetsDB.readSheet('Assessments!A2:G');
                
                // Clear current assessment data
                assessmentData = {};
                
                data.forEach(row => {
                    const [employee, skill, rating, category, date, comment, trainingRequested] = row;
                    
                    if (employee && skill && rating) {
                        if (!assessmentData[employee]) {
                            assessmentData[employee] = {};
                        }
                        assessmentData[employee][skill] = rating;
                    }
                });
                
                console.log('Loaded assessments from Google Sheets');
                saveAssessmentData(); // Save to localStorage as backup
                
                // Update UI
                if (supervisorAccess) {
                    updateAnalytics();
                }
                populateEmployeeGrid();
            } catch (error) {
                console.error('Failed to load assessments from Sheets:', error);
            }
        }

        // Save single assessment to Google Sheets
        async function saveAssessmentToSheets(employeeName, skill, rating) {
            if (!GoogleSheetsDB.isSignedIn) return;
            
            try {
                // Find category for this skill
                let category = '';
                for (const [cat, skills] of Object.entries(skillsData)) {
                    if (skills.includes(skill)) {
                        category = cat;
                        break;
                    }
                }
                
                // Check if this assessment already exists
                const existingData = await GoogleSheetsDB.readSheet('Assessments!A2:G');
                let rowIndex = -1;
                
                for (let i = 0; i < existingData.length; i++) {
                    if (existingData[i][0] === employeeName && existingData[i][1] === skill) {
                        rowIndex = i + 2; // +2 because sheet is 1-indexed and we skip header
                        break;
                    }
                }
                
                const values = [[
                    employeeName,
                    skill,
                    rating,
                    category,
                    new Date().toISOString().split('T')[0],
                    '', // comment
                    'FALSE' // training requested
                ]];
                
                if (rowIndex > 0) {
                    // Update existing row
                    await GoogleSheetsDB.writeSheet(`Assessments!A${rowIndex}:G${rowIndex}`, values);
                } else {
                    // Append new row
                    await GoogleSheetsDB.appendSheet('Assessments!A:G', values);
                }
                
                console.log('Assessment saved to Google Sheets');
            } catch (error) {
                console.error('Failed to save assessment to Sheets:', error);
            }
        }

        // Override existing functions to add Google Sheets sync
        const originalSaveEmployeesList = saveEmployeesList;
        saveEmployeesList = async function() {
            originalSaveEmployeesList(); // Save to localStorage
            await saveEmployeesToSheets(); // Also save to Google Sheets
        };

        // Override selectRating to save to Sheets
        const originalSelectRating = selectRating;
        selectRating = async function(skill, rating) {
            originalSelectRating(skill, rating); // Original function
            
            // Save to Google Sheets if connected
            if (GoogleSheetsDB.isSignedIn && currentEmployee) {
                await saveAssessmentToSheets(currentEmployee, skill, rating);
            }
        };

        // Add Google Sign-In button to the header
        function addGoogleSignInButton() {
            const navButtons = document.querySelector('.nav-buttons');
            if (navButtons) {
                const signInBtn = document.createElement('button');
                signInBtn.id = 'googleSignInBtn';
                signInBtn.className = 'btn';
                signInBtn.textContent = 'Enable Sync';
                signInBtn.style.background = '#4285f4';
                signInBtn.onclick = function() {
                    if (GoogleSheetsDB.isSignedIn) {
                        GoogleSheetsDB.signOut();
                    } else {
                        GoogleSheetsDB.signIn();
                    }
                };
                navButtons.appendChild(signInBtn);
            }
        }

        // Initialize Google Sheets on page load
        const originalInitializeApp = initializeApp;
        initializeApp = async function() {
            await originalInitializeApp(); // Run original initialization
            
            // Add Google sign-in button
            addGoogleSignInButton();
            
            // Initialize Google API
            if (typeof gapi !== 'undefined') {
                try {
                    await GoogleSheetsDB.init();
                } catch (error) {
                    console.error('Failed to initialize Google Sheets:', error);
                    showNotification('Google Sheets integration unavailable - using local storage only');
                }
            } else {
                console.log('Waiting for Google API to load...');
                // Set up callback for when API loads
                window.onload = async function() {
                    if (typeof gapi !== 'undefined') {
                        try {
                            await GoogleSheetsDB.init();
                        } catch (error) {
                            console.error('Failed to initialize Google Sheets:', error);
                        }
                    }
                };
            }
        };

        // Initialize the application when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>

    <!-- Google API Scripts -->
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>
</body>
</html>
